 %%[
  var @First_Name, @Last_Name, @Company_Name, @Fleet_Manager_Email_Address, @Personal_Email_Address, @Submitted_Answer_1, @Submitted_Answer_2, @Submitted_Answer_3, @Submitted_Answer_4, @Submitted_Answer_5, @Submitted_Answer_6, @Submitted_Answer_7, @Submitted_Answer_8, @Submitted_Answer_9, @Submitted_Answer_10,@submit_value,@formSubmit, @Correct_answer_value,@formblock,@thankyoublock,
@ts, @ts_def,@ts_sub,@EmailAddr
  
  SET @formblock='block'
  SET @thankyoublock='none'  
  
  SET @formSubmit_value="False"  

  IF RequestParameter("formSubmit") == true THEN
  SET @formSubmit_value=RequestParameter("formSubmit") 
  
  SET @First_Name = RequestParameter("firstname")
  SET @Last_Name = RequestParameter("lastname")
  SET @Company_Name = RequestParameter("companyname")
  SET @Fleet_Manager_Email_Address = RequestParameter("fleetmanageremail")
  SET @Personal_Email_Address = RequestParameter("personalemail")
  SET @Submitted_Answer_1 = RequestParameter("InputQ1")
  SET @Submitted_Answer_2 = RequestParameter("InputQ2")
  SET @Submitted_Answer_3 = RequestParameter("InputQ3")
  SET @Submitted_Answer_4 = RequestParameter("InputQ4")
  SET @Submitted_Answer_5 = RequestParameter("InputQ5")
  SET @Submitted_Answer_6 = RequestParameter("InputQ6")
  SET @Submitted_Answer_7 = RequestParameter("InputQ7")
  SET @Submitted_Answer_8 = RequestParameter("InputQ8")
  SET @Submitted_Answer_9 = RequestParameter("InputQ9")
  SET @Submitted_Answer_10 = RequestParameter("InputQ10")
  SET @Correct_answer_value = RequestParameter("answersCounter")
    
  SET @formblock="none"
  SET @thankyoublock="block"
  set @Unique_Send_ID = GUID()  
  
   InsertDE("Quiz_Responses",
   "First_Name",@First_Name,
   "Last_Name",@Last_Name,
   "Company_Name",@Company_Name,
   "Fleet_Manager_Email_Address", @Fleet_Manager_Email_Address,
   "Personal_Email_Address",@Personal_Email_Address,
   "Submitted_Answer_1",@Submitted_Answer_1,
   "Submitted_Answer_2",@Submitted_Answer_2,
   "Submitted_Answer_3",@Submitted_Answer_3,
   "Submitted_Answer_4",@Submitted_Answer_4,
   "Submitted_Answer_5",@Submitted_Answer_5,
   "Submitted_Answer_6",@Submitted_Answer_6,
   "Submitted_Answer_7",@Submitted_Answer_7,
   "Submitted_Answer_8",@Submitted_Answer_8,
   "Submitted_Answer_9",@Submitted_Answer_9,
   "Submitted_Answer_10",@Submitted_Answer_10,
   "Correct_Answers",@Correct_answer_value,
   "Submit_Date",Now(1),
   "Unique_Send_ID",@Unique_Send_ID)   
  
  SET @SubscriberKey = "testemail@yopmail.com"
  SET @EmailAddress = "testemail@yopmail.com"
 
  SET @TriggerSendExternalKey = "001"

/* Manager Email Send */

 /* Specify the external key of the TriggerSend */
 SET @TriggerSend = CreateObject("TriggeredSend")
 SET @TriggerSendDefinition = CreateObject("TriggeredSendDefinition")
 SetObjectProperty(@TriggerSendDefinition, "CustomerKey", @TriggerSendExternalKey)
 SetObjectProperty(@TriggerSend, "TriggeredSendDefinition", @TriggerSendDefinition)

 /* Specify the email address and the subscriber key */
 SET @TriggerSendSubscriber = CreateObject("Subscriber")
 SetObjectProperty(@TriggerSendSubscriber, "EmailAddress", @EmailAddress) 
 SetObjectProperty(@TriggerSendSubscriber, "SubscriberKey", @SubscriberKey) 


 /* Fill out the Attributes field in the TriggerSend data extension */
 SET @attr = CreateObject("Attribute")
 SetObjectProperty(@attr, "Name", "Unique_Send_ID")
 SetObjectProperty(@attr,"Value", @Unique_Send_ID)
 AddObjectArrayItem(@TriggerSend, "Attributes", @attr)
 AddObjectArrayItem(@TriggerSend, "Subscribers", @TriggerSendSubscriber)   

 SET @TriggerSend_statusCode = InvokeCreate(@TriggerSend, @TriggerSend_statusMsg, @errorCode) 

 IF @TriggerSend_statusCode != "OK" THEN
  OUTPUTLINE(CONCAT("Status: ",@TriggerSend_statusMsg," / Code: ",@errorCode))
 ENDIF
 
/* Customer Email Send Fleet ManagerEmail address*/
 
IF NOT EMPTY(@Fleet_Manager_Email_Address)  THEN


 SET @EmailAddress2 = @Fleet_Manager_Email_Address
 SET @TriggerSendExternalKey2 = "002"

/* Check if the Email Address is already existing subscriber  */
SET @Existing_subscribers = LookupOrderedRows("ent._Subscribers",1,"DateJoined Desc","EmailAddress",@Fleet_Manager_Email_Address,"Status","Active")
Set @rowcount2=RowCount(@Existing_subscribers)

/* Set subscriber key for the email */
IF @rowCount2 > 0 then
  set @row = row(@Existing_subscribers,1) /* get row #1 */
  set @SubscriberKey2 = field(@row,"SubscriberKey")
Else
 SET @SubscriberKey2 = GUID()
EndIF
 
 /* Specify the external key of the TriggerSend */
 SET @TriggerSend2 = CreateObject("TriggeredSend")
 SET @TriggerSendDefinition2 = CreateObject("TriggeredSendDefinition")
 SetObjectProperty(@TriggerSendDefinition2, "CustomerKey", @TriggerSendExternalKey2)
 SetObjectProperty(@TriggerSend2, "TriggeredSendDefinition", @TriggerSendDefinition2)

 /* Specify the email address and the subscriber key */
 SET @TriggerSendSubscriber2 = CreateObject("Subscriber")
 SetObjectProperty(@TriggerSendSubscriber2, "EmailAddress", @EmailAddress2) 
 SetObjectProperty(@TriggerSendSubscriber2, "SubscriberKey", @SubscriberKey2) 

 /* Fill out the Attributes field in the TriggerSend data extension */
 SET @attr = CreateObject("Attribute")
 SetObjectProperty(@attr, "Name", "Unique_Send_ID")
 SetObjectProperty(@attr,"Value", @Unique_Send_ID)
 AddObjectArrayItem(@TriggerSend2, "Attributes", @attr)
 AddObjectArrayItem(@TriggerSend2, "Subscribers", @TriggerSendSubscriber2)  

 SET @TriggerSend_statusCode = InvokeCreate(@TriggerSend2, @TriggerSend2_statusMsg, @errorCode) 

 IF @TriggerSend_statusCode != "OK" THEN
  OUTPUTLINE(CONCAT("Status_MEA: ",@TriggerSend2_statusMsg," / Code: ",@errorCode))
 ENDIF
 
ENDIF 

 /* Customer Email Send Fleet Personal_Email_Address */
 
IF NOT EMPTY(@Personal_Email_Address)  THEN

 SET @SubscriberKey3 = GUID()
 SET @EmailAddress3 = @Personal_Email_Address
 
 SET @TriggerSendExternalKey3 = "003"

 SET @Existing_subscribers = LookupOrderedRows("ent._Subscribers",1,"DateJoined Desc","EmailAddress",@Personal_Email_Address,"Status","Active")
Set @rowcount2=RowCount(@Existing_subscribers)

/* Set subscriber key for the email */
IF @rowCount2 > 0 then
  set @row = row(@Existing_subscribers,1) /* get row #1 */
  set @SubscriberKey3 = field(@row,"SubscriberKey")
Else
 SET @SubscriberKey3 = GUID()
EndIF 
 
 /* Specify the external key of the TriggerSend */
 SET @TriggerSend3 = CreateObject("TriggeredSend")
 SET @TriggerSendDefinition3 = CreateObject("TriggeredSendDefinition")
 SetObjectProperty(@TriggerSendDefinition3, "CustomerKey", @TriggerSendExternalKey3)
 SetObjectProperty(@TriggerSend3, "TriggeredSendDefinition", @TriggerSendDefinition3)

 /* Specify the email address and the subscriber key */
 SET @TriggerSendSubscriber3 = CreateObject("Subscriber")
 SetObjectProperty(@TriggerSendSubscriber3, "EmailAddress", @EmailAddress3) 
 SetObjectProperty(@TriggerSendSubscriber3, "SubscriberKey", @SubscriberKey3) 

 /* Fill out the Attributes field in the TriggerSend data extension */
 SET @attr = CreateObject("Attribute")
 SetObjectProperty(@attr, "Name", "Unique_Send_ID")
 SetObjectProperty(@attr,"Value", @Unique_Send_ID)
 AddObjectArrayItem(@TriggerSend3, "Attributes", @attr)
 AddObjectArrayItem(@TriggerSend3, "Subscribers", @TriggerSendSubscriber3)  

 SET @TriggerSend_statusCode = InvokeCreate(@TriggerSend3, @TriggerSend3_statusMsg, @errorCode) 

 IF @TriggerSend_statusCode != "OK" THEN
  OUTPUTLINE(CONCAT("Status_PEA: ",@TriggerSend3_statusMsg," / Code: ",@errorCode))
 ENDIF
 
ENDIF 
  ENDIF

  ]%%
  
